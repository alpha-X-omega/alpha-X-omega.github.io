{
 "cells": [
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    "******************************************\n",
    "Estimation â€“ 2D Projective Transformations\n",
    "******************************************"
   ]
  },
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    ".. _hartley2004-ex-4.i:\n",
    "\n",
    "(i) Computing Homographies of :math:`\\mathbb{P}^n`\n",
    "==================================================\n",
    "\n",
    "Each pair of point correspondences\n",
    ":math:`\\mathbf{x}, \\mathbf{x}' \\in \\mathbb{R}^m` is related by a homography\n",
    ":math:`\\mathbf{H} \\in \\mathbb{R}^{m \\times m}` such that\n",
    ":math:`\\mathbf{x}' \\sim \\mathbf{H} \\mathbf{x}`.  Let :math:`\\mathbf{h}_i^\\top`\n",
    "denote the :math:`i^\\text{th}` row of :math:`\\mathbf{H}`.\n",
    "\n",
    "Since equality is only up to a scale in homogeneous coordinates, set\n",
    ":math:`x'_m = 1` so that for :math:`i = 1, \\ldots, m`\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\frac{x'_i}{x'_m}\n",
    "    &= \\frac{\\mathbf{h}_i^\\top \\mathbf{x}}{\\mathbf{h}_m^\\top \\mathbf{x}}\\\\\n",
    "   0 &= \\mathbf{x} \\cdot \\mathbf{h}_i -\n",
    "        \\frac{x'_i}{x'_m} \\mathbf{x} \\cdot \\mathbf{h}_m\\\\\n",
    "   0 &= \\mathbf{x} \\cdot \\mathbf{h}_i - x'_i \\mathbf{x} \\cdot \\mathbf{h}_m.\n",
    "\n",
    "Given a set of :math:`n` point correspondences, organize them as\n",
    ":math:`\\mathbf{X}, \\mathbf{X}' \\in \\mathbb{R}^{n \\times m}`.  The previous\n",
    "equations can be rearranged into the following sparse linear system\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\DeclareMathOperator{\\diag}{diag}\n",
    "   \\boldsymbol{0} =\n",
    "   \\begin{bmatrix}\n",
    "     \\mathbf{X} &            &        &            & -\\diag(\\mathbf{X}'_{\\colon 1}) \\mathbf{X}\\\\\n",
    "                & \\mathbf{X} &        &            & -\\diag(\\mathbf{X}'_{\\colon 2}) \\mathbf{X}\\\\\n",
    "                &            & \\ddots &            & \\vdots\\\\\n",
    "                &            &        & \\mathbf{X} & -\\diag(\\mathbf{X}'_{\\colon (m - 1)}) \\mathbf{X}\n",
    "   \\end{bmatrix}\n",
    "   \\begin{bmatrix} \\mathbf{h}_1\\\\ \\mathbf{h}_2\\\\ \\vdots\\\\ \\mathbf{h}_m \\end{bmatrix}."
   ]
  },
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    "(ii) Computing Homographies for Ideal Points\n",
    "============================================\n",
    "\n",
    "When one of the points :math:`\\mathbf{x}'_i` is an ideal point,\n",
    ":ref:`the previous formulation <hartley2004-ex-4.i>` results in a degenerate\n",
    "system of equations.  One solution is to rewrite the corresponding constraint as\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathbf{x}'_i &= \\mathbf{H} \\mathbf{x}_i\\\\\n",
    "   \\boldsymbol{0} &= \\mathbf{H} \\mathbf{x}_i - \\mathbf{x}'_i\\\\\n",
    "   \\boldsymbol{0}\n",
    "    &= \\left[ \\mathbf{x}'_i \\right]^\\perp\n",
    "       \\begin{bmatrix}\n",
    "         \\mathbf{h}_1^\\top \\mathbf{x}_i\\\\\n",
    "         \\mathbf{h}_2^\\top \\mathbf{x}_i\\\\\n",
    "         \\vdots\\\\\n",
    "         \\mathbf{h}_m^\\top \\mathbf{x}_i\n",
    "       \\end{bmatrix}\n",
    "\n",
    "where :math:`\\left[ \\mathbf{x}'_i \\right]^\\perp \\mathbf{x}'_i = \\boldsymbol{0}`.\n",
    "The matrix :math:`\\left[ \\mathbf{x}'_i \\right]^\\perp \\triangleq \\mathbf{P}^i`\n",
    "may be obtained by deleting the first row of the\n",
    ":ref:`Householder matrix <dennis1996numerical-ex-3.14>` :math:`\\mathbf{M}`\n",
    "satisfying :math:`\\mathbf{M} \\mathbf{x}'_i = \\alpha \\mathbf{e}_1`.  By\n",
    "inspection, the constraints for the :math:`i^\\text{th}` correspondence pair\n",
    "satisfy\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\boldsymbol{0} =\n",
    "   \\begin{bmatrix}\n",
    "     \\mathbf{P}^i_{11} \\mathbf{x}_i^\\top & \\mathbf{P}^i_{12} \\mathbf{x}_i^\\top &\n",
    "       \\cdots & \\mathbf{P}^i_{1m} \\mathbf{x}_i^\\top\\\\\n",
    "     \\mathbf{P}^i_{21} \\mathbf{x}_i^\\top & \\mathbf{P}^i_{22} \\mathbf{x}_i^\\top &\n",
    "       \\cdots & \\mathbf{P}^i_{2m} \\mathbf{x}_i^\\top\\\\\n",
    "     \\vdots & \\vdots & \\ddots & \\vdots\\\\\n",
    "     \\mathbf{P}^i_{(m - 1)1} \\mathbf{x}_i^\\top &\n",
    "       \\mathbf{P}^i_{(m - 1)2} \\mathbf{x}_i^\\top & \\cdots &\n",
    "       \\mathbf{P}^i_{(m - 1)m} \\mathbf{x}_i^\\top\\\\\n",
    "   \\end{bmatrix}\n",
    "   \\begin{bmatrix}\n",
    "     \\mathbf{h}_1\\\\ \\mathbf{h}_2\\\\ \\vdots\\\\ \\mathbf{h}_m\n",
    "   \\end{bmatrix}."
   ]
  },
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    "(iii) Scaling Unbounded Point Sets\n",
    "==================================\n",
    "\n",
    "In mathematics, a moment is a specific quantitative measure of the shape of a\n",
    "set of points.  The zeroth moment is the sum of the measurements, and the first\n",
    "moment is the mean of the measurements.  The second moment recentered around a\n",
    "known, definite mean is the variance of the distribution.\n",
    "\n",
    "Denote :math:`\\mathbf{X} \\in \\mathbb{R}^{n \\times m}` as a data matrix\n",
    "representing a set of :math:`n` observations measuring :math:`m` variables where\n",
    ":math:`\\left\\{ \\mathbf{x}_i \\in \\mathbb{R}^m \\right\\}_{i = 1}^n` is a set of\n",
    "independent and identically distributed real-valued random vector.\n",
    "\n",
    "The centroid (a.k.a. first moment, sample mean) over the random vectors is\n",
    "defined as :math:`\\overline{\\mathbf{x}} = n^{-1} \\sum_i \\mathbf{x}_i`.\n",
    "\n",
    "Isotropic Scaling\n",
    "-----------------\n",
    "\n",
    "The goal of isotropic scaling is to compute a similarity transformation\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathrm{T} =\n",
    "   \\begin{bmatrix}\n",
    "     s & 0 & t_x\\\\\n",
    "     0 & s & t_y\\\\\n",
    "     0 & 0 & 1\n",
    "   \\end{bmatrix}\n",
    "\n",
    "such that\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathrm{T} \\overline{\\mathbf{x}} =\n",
    "   \\begin{bmatrix}\n",
    "     s & 0 & t_x\\\\\n",
    "     0 & s & t_y\\\\\n",
    "     0 & 0 & 1\n",
    "   \\end{bmatrix}\n",
    "   \\begin{bmatrix} \\overline{x}\\\\ \\overline{y}\\\\ 1 \\end{bmatrix} =\n",
    "   \\begin{bmatrix}\n",
    "     s \\overline{x} + t_x\\\\\n",
    "     s \\overline{y} + t_x\\\\\n",
    "     1\n",
    "   \\end{bmatrix} =\n",
    "   (0, 0, 1)^\\top =\n",
    "   \\mathbf{e}_3\n",
    "\n",
    "and\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\DeclareMathOperator{\\dist}{dist}\n",
    "   n^{-1} \\sum_i \\dist\\left( \\mathrm{T} \\mathbf{x}_i, \\mathbf{e}_3 \\right) =\n",
    "   n^{-1} \\sum_i \\sqrt{(s x_i + t_x)^2 + (s y_i + t_y)^2} =\n",
    "   \\sqrt{2}.\n",
    "\n",
    "By inspection, assigning :math:`t_x = -s \\overline{x}` and\n",
    ":math:`t_y = -s \\overline{y}` accomplishes the former objective and restricts\n",
    "the latter criterion to\n",
    "\n",
    ".. math::\n",
    "\n",
    "   n^{-1} \\sum_i \\sqrt{\n",
    "     (s x_i - s \\overline{x})^2 + (s y_i - s \\overline{y})^2\n",
    "   } &= \\sqrt{2}\\\\\n",
    "   s &= \\frac{n \\sqrt{2}}{\n",
    "          \\sum_i \\sqrt{(x_i - \\overline{x})^2 + (y_i - \\overline{y})^2}\n",
    "        }.\n",
    "\n",
    "The normalized DLT can be understood as\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathrm{T}' \\mathbf{x}'_i &= \\tilde{\\mathrm{H}} \\mathrm{T} \\mathbf{x}_i\\\\\n",
    "   \\mathbf{x}'_i &= \\mathrm{H} \\mathbf{x}_i\n",
    "\n",
    "where :math:`\\mathrm{H} = {\\mathrm{T}'}^{-1} \\tilde{\\mathrm{H}} \\mathrm{T}`.\n",
    "\n",
    "Non-Isotropic Scaling\n",
    "---------------------\n",
    "\n",
    "The goal of non-isotropic scaling (a.k.a. decorrelating and whitening) is to\n",
    "produce a normalized moment with zero mean and identity covariance.  Both\n",
    "moments are unknown and have to be estimated.\n",
    "\n",
    "Recall that the covariance matrix of two random vectors is defined as\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\DeclareMathOperator{\\E}{\\mathbb{E}}\n",
    "   \\DeclareMathOperator{\\Cov}{\\mathrm{Cov}}\n",
    "   \\Cov(X, Y)\n",
    "    &= \\E\\left[ \\left( X - \\E[X] \\right) \\left( Y - \\E[Y] \\right)^\\top \\right]\\\\\n",
    "    &= \\E\\left[ X Y^\\top \\right] - \\E\\left[ X \\E[Y]^\\top \\right] -\n",
    "       \\E\\left[ \\E[X] Y^\\top \\right] + \\E\\left[ \\E[X] \\E[Y]^\\top \\right]\\\\\n",
    "    &= \\E\\left[ X Y^\\top \\right] - 2 \\E[X] \\E[Y]^\\top + \\E[X] \\E[Y]^\\top\\\\\n",
    "    &= \\E\\left[ X Y^\\top \\right] - \\E[X] \\E[Y]^\\top.\n",
    "\n",
    "A special case of the covariance matrix is the correlation matrix\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\DeclareMathOperator{\\diag}{\\mathrm{diag}}\n",
    "   \\DeclareMathOperator{\\Corr}{\\mathrm{Corr}}\n",
    "   \\DeclareMathOperator{\\sd}{\\mathrm{sd}}\n",
    "   \\Corr(X, Y) =\n",
    "   \\sd(X)^{-1} \\Cov(X, Y) \\sd(Y)^{-1}\n",
    "\n",
    "where\n",
    ":math:`\\sd(\\cdot) \\triangleq \\diag\\left( \\Cov(\\cdot, \\cdot) \\right)^{1 / 2}`\n",
    "represents the standard deviation.\n",
    "\n",
    "The covariance matrix of a random vector with itself is called the\n",
    "variance-covariance matrix:\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\DeclareMathOperator*{\\Var}{\\mathrm{Var}}\n",
    "   \\Var(X) =\n",
    "   \\Cov(X, X) =\n",
    "   \\E\\left[ X X^\\top \\right] - \\E[X] \\E[X]^\\top =\n",
    "   \\begin{bmatrix}\n",
    "     \\Var(X_1) & \\Cov(X_1, X_2) & \\cdots & \\Cov(X_1, X_m)\\\\\n",
    "     \\Cov(X_2, X_1) & \\Var(X_2) & \\cdots & \\Cov(X_2, X_m)\\\\\n",
    "     \\vdots & \\vdots & \\ddots & \\vdots\\\\\n",
    "     \\Cov(X_m, X_1) & \\Cov(X_m, X_2) & \\cdots & \\Var(X_m)\n",
    "   \\end{bmatrix}.\n",
    "\n",
    "The sample mean :math:`\\overline{\\mathbf{x}}` is assumed to be an estimate of\n",
    "the population mean such that\n",
    ":math:`\\E\\left[ \\mathbf{x}_i \\right] = \\overline{\\mathbf{x}}`.\n",
    "\n",
    "To estimate the population covariance, the sample mean must be made\n",
    "independent of the samples used to compute it.  Hence\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\Var(\\mathbf{X})\n",
    "    &= (n - 1)^{-1} \\sum_i \\Var(\\mathbf{x}_i)\\\\\n",
    "    &= (n - 1)^{-1} \\sum_i\n",
    "         \\E\\left[ \\mathbf{x}_i \\mathbf{x}_i^\\top \\right] -\n",
    "         \\overline{\\mathbf{x}} \\overline{\\mathbf{x}}^\\top\\\\\n",
    "    &= (n - 1)^{-1} \\left(\n",
    "         \\E\\left[ \\sum_i \\mathbf{x}_i \\mathbf{x}_i^\\top \\right] -\n",
    "         n \\overline{\\mathbf{x}} \\overline{\\mathbf{x}}^\\top\n",
    "       \\right)\n",
    "       & \\quad & \\E[X + Y] = \\E[X] + \\E[Y]\\\\\n",
    "    &= (n - 1)^{-1} \\left(\n",
    "         \\E\\left[ \\mathbf{X}^\\top \\mathbf{X} \\right] -\n",
    "         n \\overline{\\mathbf{x}} \\overline{\\mathbf{x}}^\\top\n",
    "       \\right)\n",
    "       & \\quad &\n",
    "           \\sum_i \\mathbf{x}_i \\mathbf{x}_i^\\top =\n",
    "           \\begin{bmatrix} \\mathbf{x}_i & \\cdots & \\mathbf{x}_n \\end{bmatrix}\n",
    "           \\begin{bmatrix}\n",
    "             \\mathbf{x}_i^\\top\\\\ \\vdots\\\\ \\mathbf{x}_n^\\top\n",
    "           \\end{bmatrix} = \\mathbf{X}^\\top \\mathbf{X}\\\\\n",
    "    &= (n - 1)^{-1} \\E\\left[\n",
    "         \\mathbf{X}^\\top \\mathbf{X} -\n",
    "         n \\overline{\\mathbf{x}} \\overline{\\mathbf{x}}^\\top\n",
    "       \\right]\n",
    "\n",
    "reserves one of the observations (\"-1\") to account for the loss of a degree of\n",
    "freedom (given the sample mean, only :math:`n - 1` observations are needed to\n",
    "reconstruct the samples).  Occasionally the quantity\n",
    ":math:`\\mathbf{X}^\\top \\mathbf{X}` is mentioned as the uncorrected sums of\n",
    "squares and cross products (SSCP) matrix.  Likewise, the corrected SSCP\n",
    "(co-scatter) matrix is defined as\n",
    ":math:`\\mathbf{X}^\\top \\mathbf{X} - n \\overline{x} \\overline{x}^\\top`.\n",
    "\n",
    "While the preceding formulas can be used to achieve non-isotropic scaling, a\n",
    "simpler approach is to realize that the SSCP matrix is always positive\n",
    "semi-definite.  Since :math:`m < n` in this scenario,\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\DeclareMathOperator*{\\rank}{\\mathrm{rank}}\n",
    "   \\rank\\left( \\mathbf{X}^\\top \\mathbf{X} \\right) =\n",
    "   \\rank(\\mathbf{X}) \\leq\n",
    "   \\min(m, n)\n",
    "\n",
    "implies :math:`\\mathbf{X}^\\top \\mathbf{X}` is full rank (nonsingular) and thus\n",
    "positive definite.  The desired non-isotropic transformation is\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\DeclareMathOperator*{\\chol}{\\mathrm{cholesky}}\n",
    "   \\mathrm{T} =\n",
    "   \\mathbf{L}^{-1}\n",
    "     \\begin{bmatrix}\n",
    "       1 & 0 & -\\overline{x}\\\\\n",
    "       0 & 1 & -\\overline{y}\\\\\n",
    "       0 & 0 & 1\n",
    "     \\end{bmatrix}\n",
    "   \\quad \\text{with} \\quad\n",
    "   \\mathbf{L} \\mathbf{L}^\\top =\n",
    "   \\chol\\left(\n",
    "     \\mathbf{X}^\\top \\mathbf{X} -\n",
    "     n \\overline{\\mathbf{x}} \\overline{\\mathbf{x}}^\\top\n",
    "   \\right).\n",
    "\n",
    "Scaling with Points Near Infinity\n",
    "---------------------------------\n",
    "\n",
    "Given a set of points :math:`\\mathbf{x}_i = (x_i, y_i, w_i)^\\top`, the goal is\n",
    "to compute an affine transformation\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathrm{T}_0 =\n",
    "   \\begin{bmatrix}\n",
    "     1 & 0 & 0 & t_x\\\\\n",
    "     0 & 1 & 0 & t_y\\\\\n",
    "     0 & 0 & c & 0\n",
    "   \\end{bmatrix}\n",
    "\n",
    "such that\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\sum_i x_i + t_x = \\sum_i y_i + t_y = 0;\\quad\n",
    "   \\sum_i (x_i + t_x)^2 + (y_i + t_y)^2 = 2 \\sum_i (c w_i)^2;\\quad\n",
    "   (x_i + t_x)^2 + (y_i + t_y)^2 + (c w_i)^2 = 1 \\forall i.\n",
    "\n",
    "By inspection, assigning :math:`t_x = -\\overline{x}` and\n",
    ":math:`t_y = -\\overline{y}` satisfies the first condition, and defining\n",
    "\n",
    ".. math::\n",
    "\n",
    "   c^2 = \\frac{\\sum_i (x_i + t_x)^2 + (y_i + t_y)^2}{2 \\sum_i w_i^2}\n",
    "\n",
    "fulfills the second criterion.  To meet the last specification, one should not\n",
    "directly normalize the result of\n",
    ":math:`\\mathrm{T}_0 \\begin{bmatrix} \\mathbf{x}_i\\\\ 1 \\end{bmatrix}` because that\n",
    "will invalidate the previous conditions.\n",
    "\n",
    "Notice that\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\sum_i (x_i + t_x)^2 + (y_i + t_y)^2 + (c w_i)^2 = \\sum_i 1 = n.\n",
    "\n",
    "While meeting this alternative normalization is not equivalent to the original,\n",
    "the set of points will form an approximately symmetric circular point cloud of\n",
    "radius 1.  The desired transformation is\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathrm{T} = \\mathbf{L}^{-1} \\mathrm{T}_0\n",
    "   \\quad \\text{with} \\quad\n",
    "   \\mathbf{L} \\mathbf{L}^\\top = \\chol\\left( \\mathbf{Y}^\\top \\mathbf{Y} \\right)\n",
    "\n",
    "where :math:`\\mathbf{Y}` represents :math:`\\mathbf{X}` already transformed to\n",
    "satisfy the first two conditions."
   ]
  },
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    "(iv) Transformation Invariance of DLT\n",
    "=====================================\n",
    "\n",
    "Result 4.3 shows that\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\tilde{\\boldsymbol{\\epsilon}}_i\n",
    "    &= \\tilde{\\mathtt{A}}_i \\tilde{\\mathbf{h}}\n",
    "       & \\quad & \\text{(4.1)}\\\\\n",
    "    &= \\tilde{\\mathbf{x}}'_i \\times \\tilde{\\mathtt{H}} \\tilde{\\mathbf{x}}_i\\\\\n",
    "    &= {\\mathtt{T}'}^* \\boldsymbol{\\epsilon}_i\n",
    "       & \\quad & \\text{(A4.8)}\\\\\n",
    "    &= \\det(\\mathtt{T}') {\\mathtt{T}'}^{-\\top}\n",
    "       \\left( \\mathbf{x}'_i \\times \\mathtt{H} \\mathbf{x}_i \\right)\n",
    "       & \\quad & \\text{(A4.7)}\n",
    "\n",
    "where :math:`\\mathtt{T}'` and :math:`\\mathtt{T}` are arbitrary projective\n",
    "transformations (2.13).\n",
    "\n",
    "(a)\n",
    "---\n",
    "\n",
    "Suppose :math:`\\mathtt{T}'` is a similarity transformation (2.9).\n",
    "\n",
    "If :math:`\\left\\Vert \\mathtt{A} \\mathbf{h} \\right\\Vert` is minimized subject to\n",
    "the constraint :math:`h_9 = \\mathtt{H}_{33} = 1`, then\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\tilde{\\mathtt{H}}_{33}\n",
    "    &= \\left( \\mathtt{T}' \\mathtt{H} \\mathtt{T}^{-1} \\right)_{33}\\\\\n",
    "    &= \\mathbf{h}_3^\\top\n",
    "       \\begin{bmatrix} \\mathbf{t}\\\\ \\upsilon \\end{bmatrix}\\\\\n",
    "    &= h_7 t_x + h_8 t_y + \\upsilon.\n",
    "\n",
    "Notice that :math:`\\tilde{h}_9 = 1` holds for any 2D homography when\n",
    ":math:`\\upsilon = 1` and :math:`\\mathtt{T}` does not contain translations.  By\n",
    "inspection, changing the scaling factor of either transformation does not\n",
    "influence the constraint.\n",
    "\n",
    "(b)\n",
    "---\n",
    "\n",
    "Recall that multiplying :math:`\\mathtt{T}` by :math:`s^{-1}` still gives the\n",
    "same result in homogeneous coordinates.\n",
    "\n",
    "Now suppose the constraint is :math:`\\mathtt{H}_{31}^2 + \\mathtt{H}_{32}^2 = 1`.\n",
    "The result is similarity invariant because for :math:`j = 1, 2`\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\tilde{\\mathtt{H}}_{3j}\n",
    "    &= \\left( \\mathtt{T}' \\mathtt{H} \\mathtt{T}^{-1} \\right)_{3j}\\\\\n",
    "    &= h_7 a_{1j} + h_8 a_{2j} + h_9 v_{j}\n",
    "       & \\quad & \\text{(2.10)}\n",
    "\n",
    "and\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\tilde{\\mathtt{H}}^2_{31} + \\tilde{\\mathtt{H}}^2_{32}\n",
    "    &= \\left(\n",
    "         h_7 a_{11} + h_8 a_{21} + h_9 v_1\n",
    "       \\right)^2 +\n",
    "       \\left(\n",
    "         h_7 a_{12} + h_8 a_{22} + h_9 v_2\n",
    "       \\right)^2\\\\\n",
    "    &= \\left(\n",
    "         h_7 s \\cos \\theta + h_8 s \\sin \\theta\n",
    "       \\right)^2 +\n",
    "       \\left(\n",
    "         -h_7 s \\sin \\theta + h_8 s \\cos \\theta\n",
    "       \\right)^2\n",
    "       & \\quad & \\text{(2.8)}\\\\\n",
    "    &= s^2 \\left(\n",
    "         h_7^2 + \\cos^2 \\theta +\n",
    "         2 h_7 h_8 \\cos \\theta \\sin \\theta +\n",
    "         h_8^2 + \\sin^2 \\theta\n",
    "       \\right) +\n",
    "       s^2 \\left(\n",
    "         h_7^2 \\sin^2 \\theta -\n",
    "         2 h_7 h_8 \\cos \\theta \\sin \\theta +\n",
    "         h_8^2 + \\cos^2 \\theta\n",
    "       \\right)\\\\\n",
    "    &= s^2 \\left( h_7^2 + h_8^2 \\right)\n",
    "       & \\quad & \\text{Pythagorean identity}\\\\\n",
    "    &= s^2\n",
    "       & \\quad & h_7^2 + h_8^2 = 1.\n",
    "\n",
    "(c)\n",
    "---\n",
    "\n",
    "If the constraint becomes\n",
    ":math:`\\mathtt{H}_{31} = \\mathtt{H}_{32} = 0` and :math:`\\mathtt{H}_{33} = 1`,\n",
    "then for :math:`j = 1, 2`\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\tilde{\\mathtt{H}}_{3j} = v_{j} \\qquad \\text{(b)}\n",
    "\n",
    "and\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\tilde{\\mathtt{H}}_{33} = \\upsilon \\qquad \\text{(a).}\n",
    "\n",
    "By inspection, the result is affinity invariant (2.11)."
   ]
  },
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    "(v) Expressions for Image Coordinate Derivatives\n",
    "================================================\n",
    "\n",
    "Observe that\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathbf{x}' &= \\mathtt{H} \\mathbf{x}\\\\\n",
    "   \\begin{bmatrix} x'\\\\ y'\\\\ w' \\end{bmatrix}\n",
    "    &= \\begin{bmatrix}\n",
    "         \\mathbf{h}_1^\\top \\mathbf{x}\\\\\n",
    "         \\mathbf{h}_2^\\top \\mathbf{x}\\\\\n",
    "         \\mathbf{h}_3^\\top \\mathbf{x}\n",
    "       \\end{bmatrix}\n",
    "\n",
    "and\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\tilde{\\mathbf{x}}'\n",
    "    &= \\begin{bmatrix} \\tilde{x}'\\\\ \\tilde{y}' \\end{bmatrix}\\\\\n",
    "    &= \\begin{bmatrix} x' / w' \\\\ y' / w' \\end{bmatrix}\\\\\n",
    "    &= \\begin{bmatrix}\n",
    "         \\frac{\\mathbf{h}_1^\\top \\mathbf{x}}{\\mathbf{h}_3^\\top \\mathbf{x}}\\\\\n",
    "         \\frac{\\mathbf{h}_2^\\top \\mathbf{x}}{\\mathbf{h}_3^\\top \\mathbf{x}}\n",
    "       \\end{bmatrix}.\n",
    "\n",
    "(a)\n",
    "---\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\frac{\\partial \\tilde{\\mathbf{x}}'}{\\partial \\mathbf{x}}\n",
    "    &= \\begin{bmatrix}\n",
    "         \\frac{\\partial \\tilde{x}'}{\\partial x} &\n",
    "           \\frac{\\partial \\tilde{x}'}{\\partial y} &\n",
    "           \\frac{\\partial \\tilde{x}'}{\\partial w}\\\\\n",
    "         \\frac{\\partial \\tilde{y}'}{\\partial x} &\n",
    "           \\frac{\\partial \\tilde{y}'}{\\partial y} &\n",
    "           \\frac{\\partial \\tilde{y}'}{\\partial w}\n",
    "       \\end{bmatrix}\\\\\n",
    "    &= \\begin{bmatrix}\n",
    "         \\frac{\\mathbf{h}_1^\\top}{\\mathbf{h}_3 \\cdot \\mathbf{x}} -\n",
    "           \\mathbf{h}_1 \\cdot \\mathbf{x}\n",
    "             \\left( \\mathbf{h}_3 \\cdot \\mathbf{x} \\right)^{-2}\n",
    "               \\mathbf{h}_3^\\top\\\\\n",
    "         \\frac{\\mathbf{h}_2^\\top}{\\mathbf{h}_3 \\cdot \\mathbf{x}} -\n",
    "           \\mathbf{h}_2 \\cdot \\mathbf{x}\n",
    "               \\left( \\mathbf{h}_3 \\cdot \\mathbf{x} \\right)^{-2}\n",
    "               \\mathbf{h}_3^\\top\n",
    "       \\end{bmatrix}\n",
    "       & \\quad & \\text{Product Rule with Chain Rule Inside}\\\\\n",
    "    &= \\frac{1}{w'} \\begin{bmatrix}\n",
    "         \\mathbf{h}_1^\\top -\n",
    "           \\frac{\\mathbf{h}_1 \\cdot \\mathbf{x}}{w'} \\mathbf{h}_3^\\top\\\\\n",
    "         \\mathbf{h}_2^\\top -\n",
    "           \\frac{\\mathbf{h}_2 \\cdot \\mathbf{x}}{w'} \\mathbf{h}_3^\\top\n",
    "       \\end{bmatrix}\n",
    "       & \\quad & w' = \\mathbf{h}_3 \\cdot \\mathbf{x}\\\\\n",
    "    &= \\frac{1}{w'}\n",
    "         \\begin{bmatrix}\n",
    "           \\mathbf{h}_1^\\top - \\tilde{x}' \\mathbf{h}_3^\\top\\\\\n",
    "           \\mathbf{h}_2^\\top - \\tilde{y}' \\mathbf{h}_3^\\top\n",
    "         \\end{bmatrix}\n",
    "\n",
    "(b)\n",
    "---\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\frac{\\partial \\tilde{\\mathbf{x}}'}{\\partial \\mathbf{h}}\n",
    "    &= \\begin{bmatrix}\n",
    "         \\frac{\\partial \\tilde{x}'}{\\partial h_1} &\n",
    "           \\frac{\\partial \\tilde{x}'}{\\partial h_2} & \\cdots &\n",
    "           \\frac{\\partial \\tilde{x}'}{\\partial h_9}\\\\\n",
    "         \\frac{\\partial \\tilde{y}'}{\\partial h_1} &\n",
    "           \\frac{\\partial \\tilde{y}'}{\\partial h_2} & \\cdots &\n",
    "           \\frac{\\partial \\tilde{y}'}{\\partial h_9}\n",
    "       \\end{bmatrix}\\\\\n",
    "    &= \\begin{bmatrix}\n",
    "         \\frac{x}{w'} & \\frac{y}{w'} & \\frac{w}{w'} & 0 & 0 & 0 &\n",
    "           -x' \\left( w' \\right)^{-2} x &\n",
    "           -x' \\left( w' \\right)^{-2} y &\n",
    "           -x' \\left( w' \\right)^{-2} w\\\\\n",
    "         0 & 0 & 0 & \\frac{x}{w'} & \\frac{y}{w'} & \\frac{w}{w'} &\n",
    "           -y' \\left( w' \\right)^{-2} x &\n",
    "           -y' \\left( w' \\right)^{-2} y &\n",
    "           -y' \\left( w' \\right)^{-2} w\\\\\n",
    "       \\end{bmatrix}\n",
    "       & \\quad & \\text{(4.2)}\\\\\n",
    "    &= \\frac{1}{w'} \\begin{bmatrix}\n",
    "         \\mathbf{x}^\\top & \\boldsymbol{0} & -\\tilde{x}' \\mathbf{x}^\\top\\\\\n",
    "         \\boldsymbol{0} & \\mathbf{x}^\\top & -\\tilde{y}' \\mathbf{x}^\\top\n",
    "       \\end{bmatrix}"
   ]
  },
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    "(vi) Sampson Error with Non-Isotropic Error Distributions\n",
    "=========================================================\n",
    "\n",
    "Given (4.10) still holds and the point :math:`\\mathbf{X} = (x, y, x', y')` is\n",
    "measured with covariance matrix :math:`\\Sigma_{\\mathbf{X}}`, the minimization\n",
    "problem becomes\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\min_{\\boldsymbol{\\delta}_{\\mathbf{X}}} \\quad\n",
    "     \\left\\Vert\n",
    "       \\boldsymbol{\\delta}_{\\mathbf{X}}\n",
    "     \\right\\Vert^2_{\\Sigma_{\\mathbf{X}}} &\\\\\n",
    "   \\text{subject to} \\quad\n",
    "     \\mathtt{J} \\boldsymbol{\\delta}_{\\mathbf{X}} &= -\\boldsymbol{\\epsilon}.\n",
    "\n",
    "The corresponding Lagrangian is\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathcal{L} =\n",
    "   \\boldsymbol{\\delta}_{\\mathbf{X}}^\\top\n",
    "     \\Sigma_{\\mathbf{X}}^{-1}\n",
    "     \\boldsymbol{\\delta}_{\\mathbf{X}} -\n",
    "   2 \\boldsymbol{\\lambda}^\\top \\left(\n",
    "     \\mathtt{J} \\boldsymbol{\\delta}_{\\mathbf{X}} + \\boldsymbol{\\epsilon}\n",
    "   \\right).\n",
    "\n",
    "The extrema of :math:`\\mathcal{L}` must satisfy\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\boldsymbol{0}\n",
    "    &= \\frac{\\partial \\mathcal{L}}{\\partial \\boldsymbol{\\delta}_{\\mathbf{X}}}\\\\\n",
    "    &= 2 \\Sigma_{\\mathbf{X}}^{-1} \\boldsymbol{\\delta}_{\\mathbf{X}} -\n",
    "       2 \\mathtt{J}^\\top \\boldsymbol{\\lambda}\n",
    "       & \\quad & \\text{covariance matrix is always symmetric}\\\\\n",
    "   \\boldsymbol{\\delta}_{\\mathbf{X}}\n",
    "    &= \\Sigma_{\\mathbf{X}} \\mathtt{J}^\\top \\boldsymbol{\\lambda}\n",
    "\n",
    "and\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\boldsymbol{0}\n",
    "    &= \\frac{\\partial \\mathcal{L}}{\\partial \\boldsymbol{\\lambda}}\\\\\n",
    "    &= \\mathtt{J} \\boldsymbol{\\delta}_{\\mathbf{X}} + \\boldsymbol{\\epsilon}\\\\\n",
    "   \\mathtt{J} \\Sigma_{\\mathbf{X}} \\mathtt{J}^\\top \\boldsymbol{\\lambda}\n",
    "    &= -\\boldsymbol{\\epsilon}\\\\\n",
    "   \\boldsymbol{\\lambda}\n",
    "    &= -\\left(\n",
    "         \\mathtt{J} \\Sigma_{\\mathbf{X}} \\mathtt{J}^\\top\n",
    "       \\right)^{-1} \\boldsymbol{\\epsilon}.\n",
    "\n",
    "Therefore,\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\boldsymbol{\\delta}_{\\mathbf{X}} =\n",
    "   -\\Sigma_{\\mathbf{X}} \\mathtt{J}^\\top \\left(\n",
    "     \\mathtt{J} \\Sigma_{\\mathbf{X}} \\mathtt{J}^\\top\n",
    "   \\right)^{-1} \\boldsymbol{\\epsilon}\n",
    "\n",
    "and the Sampson error is\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\left\\Vert\n",
    "     \\boldsymbol{\\delta}_{\\mathbf{X}}\n",
    "   \\right\\Vert^2_{\\Sigma_{\\mathbf{X}}}\n",
    "    &= \\boldsymbol{\\delta}_{\\mathbf{X}}^\\top\n",
    "       \\Sigma_{\\mathbf{X}}^{-1}\n",
    "       \\boldsymbol{\\delta}_{\\mathbf{X}}\\\\\n",
    "    &= \\boldsymbol{\\epsilon}^\\top\n",
    "       \\left(\n",
    "         \\mathtt{J} \\Sigma_{\\mathbf{X}} \\mathtt{J}^\\top\n",
    "       \\right)^{-\\top}\n",
    "       \\mathtt{J} \\Sigma_{\\mathbf{X}}^\\top \\mathtt{J}^\\top\n",
    "       \\left(\n",
    "         \\mathtt{J} \\Sigma_{\\mathbf{X}} \\mathtt{J}^\\top\n",
    "       \\right)^{-1} \\boldsymbol{\\epsilon}\\\\\n",
    "    &= \\boldsymbol{\\epsilon}^\\top\n",
    "       \\left(\n",
    "         \\mathtt{J} \\Sigma_{\\mathbf{X}} \\mathtt{J}^\\top\n",
    "       \\right)^{-1}\n",
    "       \\boldsymbol{\\epsilon}\n",
    "       & \\quad & \\left( \\mathbf{A}^\\top \\right)^{-1} =\n",
    "                 \\left( \\mathbf{A}^{-1} \\right)^\\top."
   ]
  },
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    "(vii) Sampson Error Programming Hint\n",
    "====================================\n",
    "\n",
    "Recall that\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\newcommand{\\variety}[2]{\\operatorname{\\mathcal{#1}}_\\mathtt{#2}}\n",
    "   \\variety{C}{H}(\\mathbf{X})\n",
    "    &= \\mathtt{A}(\\mathbf{X}) \\mathbf{h}\n",
    "       & \\quad & \\text{(4.10)}\\\\\n",
    "    &= \\begin{bmatrix}\n",
    "         \\boldsymbol{0}^\\top & -\\mathbf{x}^\\top & y' \\mathbf{x}^\\top\\\\\n",
    "         \\mathbf{x}^\\top & \\boldsymbol{0}^\\top & -x' \\mathbf{x}^\\top\n",
    "       \\end{bmatrix}\n",
    "       \\begin{bmatrix} \\mathbf{h}_1\\\\ \\mathbf{h}_2\\\\ \\mathbf{h}_3 \\end{bmatrix}\n",
    "       & \\quad & \\text{(4.3)}.\n",
    "\n",
    "The partial derivative matrix may be computed as\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\frac{\\partial \\variety{C}{H}(\\mathbf{X})}{\\partial \\mathbf{X}} =\n",
    "   \\begin{bmatrix}\n",
    "     \\frac{\\partial \\variety{C}{H}(\\mathbf{X})}{\\partial X_1} &\n",
    "       \\cdots &\n",
    "       \\frac{\\partial \\variety{C}{H}(\\mathbf{X})}{\\partial X_4}\n",
    "   \\end{bmatrix} =\n",
    "   \\mathtt{J}\n",
    "\n",
    "where\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\frac{\\partial \\variety{C}{H}(\\mathbf{X})}{\\partial X_i} =\n",
    "   \\variety{C}{H}\\left( \\mathbf{X} + \\mathbf{E}_i \\right) -\n",
    "   \\variety{C}{H}(\\mathbf{X})\n",
    "\n",
    "because w.l.o.g.\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\frac{\\partial \\variety{C}{H}(\\mathbf{X})}{\\partial X_1}\n",
    "    &= \\frac{\\partial}{\\partial x}\n",
    "       \\begin{bmatrix}\n",
    "         0 & 0 & 0 & -x & -y & -1 & y' x & y' y & y'\\\\\n",
    "         x & y & 1 & 0 & 0 & 0 & -x' x & -x' y & -x'\n",
    "       \\end{bmatrix}\n",
    "       \\mathbf{h}\\\\\n",
    "    &= \\begin{bmatrix}\n",
    "         0 & 0 & 0 & -1 & 0 & 0 & y' & 0 & 0\\\\\n",
    "         1 & 0 & 0 & 0 & 0 & 0 & -x' & 0 & 0\n",
    "       \\end{bmatrix}\n",
    "       \\mathbf{h}\\\\\n",
    "    &= \\left(\n",
    "         \\begin{bmatrix}\n",
    "           0 & 0 & 0 & -(x + 1) & -y & -1 & y' (x + 1) & y' y & y'\\\\\n",
    "           x + 1 & y & 1 & 0 & 0 & 0 & -x' (x + 1) & -x' y & -x'\n",
    "         \\end{bmatrix} -\n",
    "         \\begin{bmatrix}\n",
    "           0 & 0 & 0 & -x & -y & -1 & y' x & y' y & y'\\\\\n",
    "           x & y & 1 & 0 & 0 & 0 & -x' x & -x' y & -x'\n",
    "         \\end{bmatrix}\n",
    "       \\right)\n",
    "       \\mathbf{h}\\\\\n",
    "   &= \\variety{C}{H}\\left( \\mathbf{X} + \\mathbf{E}_1 \\right) -\n",
    "      \\variety{C}{H}(\\mathbf{X}).\n",
    "\n",
    "Consider a matrix :math:`A \\in \\mathbb{R}^{m \\times n}` and\n",
    ":math:`B \\in \\mathbb{R}^{n \\times p}` where :math:`a_i \\in \\mathbb{R}^m` and\n",
    ":math:`b_i \\in \\mathbb{R}^p`.\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\newcommand{\\textemdash}{\\unicode{x2014}}\n",
    "   AB =\n",
    "   \\begin{bmatrix}\n",
    "     \\vert & \\vert &  & \\vert\\\\\n",
    "     a_1 & a_2 & \\cdots & a_n\\\\\n",
    "     \\vert & \\vert &  & \\vert\n",
    "   \\end{bmatrix}\n",
    "     \\begin{bmatrix}\n",
    "       \\textemdash & b_1^\\top & \\textemdash\\\\\n",
    "       \\textemdash & b_2^\\top & \\textemdash\\\\\n",
    "        & \\vdots & \\\\\n",
    "       \\textemdash & b_n^\\top & \\textemdash\\\\\n",
    "     \\end{bmatrix} =\n",
    "   \\sum_{i = 1}^n a_i b_i^\\top\n",
    "\n",
    "Observe that\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathtt{J} \\mathtt{J}^\\top\n",
    "    &= \\sum_i\n",
    "         \\frac{\\partial \\variety{C}{H}}{\\partial X_i}\n",
    "         \\frac{\\partial \\variety{C}{H}}{\\partial X_i}^\\top\\\\\n",
    "    &= \\sum_i\n",
    "         \\left[\n",
    "           \\variety{C}{H}\\left( \\mathbf{X} + \\mathbf{E}_i \\right) -\n",
    "           \\variety{C}{H}(\\mathbf{X})\n",
    "         \\right]\n",
    "         \\left[\n",
    "           \\variety{C}{H}\\left( \\mathbf{X} + \\mathbf{E}_i \\right) -\n",
    "           \\variety{C}{H}(\\mathbf{X})\n",
    "         \\right]^\\top."
   ]
  },
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    "(viii) Minimizing Geometric Error for Affine Transformations\n",
    "============================================================\n",
    "\n",
    "Given a set of correspondences :math:`(x_i, y_i) \\leftrightarrow (x'_i, y'_i)`,\n",
    "the goal is to find an affine transformation :math:`\\mathtt{H}_{\\mathrm{A}}`\n",
    "that minimizes the reprojection error (4.8):\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\sum_i\n",
    "     d\\left( \\mathbf{x}_i, \\hat{\\mathbf{x}}_i \\right)^2 +\n",
    "     d\\left( \\mathbf{x}'_i, \\hat{\\mathbf{x}}'_i \\right)^2\n",
    "   \\quad \\text{subject to }\n",
    "   \\hat{\\mathbf{x}}'_i = \\mathtt{H}_{\\mathrm{A}} \\hat{\\mathbf{x}}_i\\, \\forall i.\n",
    "\n",
    "Since :math:`\\mathbf{h}_3 = \\mathbf{e}_3` in (2.10), the minimal solution would\n",
    "assign\n",
    ":math:`w_i = \\hat{w}_i = w'_i = \\mathbf{h}_3 \\cdot \\hat{\\mathbf{x}}_i = 1`\n",
    "resulting in\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\sum_i\n",
    "     (x_i - \\hat{x}_i)^2 + (y_i - \\hat{y}_i)^2 +\n",
    "     (x'_i - \\mathbf{h}_1 \\cdot \\hat{\\mathbf{x}}_i)^2 +\n",
    "     (y'_i - \\mathbf{h}_2 \\cdot \\hat{\\mathbf{x}}_i)^2.\n",
    "\n",
    "Recall that the reprojection error measured in both the images is equivalent to\n",
    "geometric distance in :math:`\\mathbb{R}^4`.  This means finding the homography\n",
    ":math:`\\mathtt{H}_{\\mathrm{A}}` and the estimated points\n",
    ":math:`\\hat{\\mathbf{x}}_i` and :math:`\\hat{\\mathbf{x}}'_i` that minimize (4.8)\n",
    "is equivalent to finding the variety :math:`\\mathcal{V}_{\\mathtt{H}}` and points\n",
    ":math:`\\hat{\\mathbf{X}}_i` on :math:`\\mathcal{V}_{\\mathtt{H}}` that minimize\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\sum_i \\left\\Vert \\mathbf{X}_i - \\hat{\\mathbf{X}}_i \\right\\Vert^2 =\n",
    "   \\sum_i\n",
    "     \\left\\Vert\n",
    "       \\begin{bmatrix} x_i\\\\ y_i\\\\ x'_i\\\\ y'_i \\end{bmatrix} -\n",
    "       \\begin{bmatrix}\n",
    "         \\hat{x}_i\\\\ \\hat{y}_i\\\\ \\hat{x}'_i\\\\ \\hat{y}'_i\n",
    "       \\end{bmatrix}\n",
    "     \\right\\Vert^2.\n",
    "\n",
    "The point :math:`\\hat{\\mathbf{X}}` on :math:`\\mathcal{V}_{\\mathtt{H}}` that lies\n",
    "closest to a measured point :math:`\\mathbf{X}` is a point where the line\n",
    "between :math:`\\mathbf{X}` and :math:`\\hat{\\mathbf{X}}` is perpendicular to the\n",
    "tangent plane to :math:`\\mathcal{V}_{\\mathtt{H}}` at :math:`\\hat{\\mathbf{X}}`.\n",
    "In other words, the perpendicular distance of each point to the variety\n",
    "\n",
    ".. math::\n",
    "\n",
    "   d_\\perp\\left( \\mathbf{X}_i, \\mathcal{V}_{\\mathtt{H}} \\right)^2 =\n",
    "   d\\left( \\mathbf{x}_i, \\hat{\\mathbf{x}}_i \\right)^2 +\n",
    "       d\\left( \\mathbf{x}'_i, \\hat{\\mathbf{x}}'_i \\right)^2.\n",
    "\n",
    "The foregoing are merely different interpretations of the same non-linear\n",
    "estimation problem.  The points :math:`\\hat{\\mathbf{X}}_i` cannot be estimated\n",
    "directly except via iteration because of the non-linear nature of the variety\n",
    ":math:`\\mathcal{V}_{\\mathtt{H}}`.\n",
    "\n",
    "The idea of the Sampson error function (4.10) is to estimate a first-order\n",
    "approximation to the point :math:`\\hat{\\mathbf{X}}`, assuming the cost function\n",
    "is well approximated linearly in the neighborhood of the estimated point.\n",
    "The variety :math:`\\mathcal{V}_{\\mathtt{H}}` for this problem must satisfy\n",
    "(4.3), or\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathcal{C}_{\\mathtt{H}}(\\mathbf{X}) =\n",
    "   \\mathtt{A}(\\mathbf{X}) \\mathbf{h} =\n",
    "   \\boldsymbol{0},\n",
    "\n",
    "so that\n",
    ":math:`\\boldsymbol{\\epsilon}_i = \\mathcal{C}_{\\mathtt{H}}(\\mathbf{X}_i)` and\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathtt{J}_i\n",
    "    &= \\frac{\n",
    "         \\partial \\mathcal{C}_{\\mathtt{H}}(\\mathbf{X}_i)\n",
    "       }{\n",
    "         \\partial \\mathbf{X}\n",
    "       }\\\\\n",
    "    &= \\frac{\\partial}{\\partial \\mathbf{X}}\n",
    "       \\begin{bmatrix}\n",
    "         \\boldsymbol{0}^\\top & -w'_i \\mathbf{x}_i^\\top &\n",
    "           y'_i \\mathbf{x}_i^\\top\\\\\n",
    "         w'_i \\mathbf{x}_i^\\top & \\boldsymbol{0}^\\top &\n",
    "           -x'_i \\mathbf{x}_i^\\top\n",
    "       \\end{bmatrix}\n",
    "       \\begin{bmatrix}\n",
    "         \\mathbf{h}_1\\\\ \\mathbf{h}_2\\\\ \\mathbf{h}_3\n",
    "       \\end{bmatrix}\n",
    "       & \\quad & \\text{(4.3)}\\\\\n",
    "    &= \\frac{\\partial}{\\partial \\mathbf{X}}\n",
    "       \\begin{bmatrix}\n",
    "         w'_i \\mathbf{x}^\\top \\mathbf{h}_1 -\n",
    "             x'_i \\mathbf{x}_i^\\top \\mathbf{h}_3\\\\\n",
    "         w'_i \\mathbf{x}^\\top \\mathbf{h}_2 -\n",
    "             y'_i \\mathbf{x}_i^\\top \\mathbf{h}_3\n",
    "       \\end{bmatrix}\n",
    "       & \\quad & \\text{negated and swapped first row}\\\\\n",
    "    &= \\begin{bmatrix}\n",
    "         w'_i h_{11} - x'_i h_{31} & -w'_i h_{12} - x'_i h_{32} &\n",
    "             -\\mathbf{x}_i^\\top \\mathbf{h}_3 & 0\\\\\n",
    "         w'_i h_{21} - y'_i h_{31} & w'_i h_{22} - y'_i h_{32} &\n",
    "             0 & -\\mathbf{x}_i^\\top \\mathbf{h}_3\n",
    "       \\end{bmatrix}\\\\\n",
    "    &= \\begin{bmatrix}\n",
    "         w'_i h_{11} & -w'_i h_{12} & -w_i & 0\\\\\n",
    "         w'_i h_{21} & w'_i h_{22} & 0 & -w_i\n",
    "       \\end{bmatrix}\n",
    "       & \\quad & \\mathbf{h}_3 = \\mathbf{e}_3\\\\\n",
    "    &= \\left[\n",
    "         \\begin{array}{c|c} \\mathtt{H}_{2 \\times 2} & -\\mathtt{I} \\end{array}\n",
    "       \\right]\n",
    "       & \\quad & w' = w = 1.\n",
    "\n",
    "One benefit of the Sampson error function is that it avoids computing\n",
    ":math:`\\hat{\\mathbf{X}}`, and hence only the estimation of\n",
    ":math:`\\mathtt{H}_{\\mathrm{A}}` remains.  The error over all the point\n",
    "correspondences is defined as\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathcal{D}_\\perp\n",
    "    &= \\sum_i \\left\\Vert \\boldsymbol{\\delta}_{\\mathbf{X}_i} \\right\\Vert^2\n",
    "       & \\quad & \\text{(4.12)}\\\\\n",
    "    &= \\sum_i\n",
    "         \\boldsymbol{\\epsilon}_i^\\top\n",
    "         \\left( \\mathtt{J}_i \\mathtt{J}_i^\\top \\right)^{-1}\n",
    "         \\boldsymbol{\\epsilon}_i\n",
    "       & \\quad & \\text{(4.13)}\\\\\n",
    "    &= \\sum_i\n",
    "         \\begin{bmatrix}\n",
    "           -\\mathbf{x}_i^\\top \\mathbf{h}_2 + y'_i &\n",
    "             \\mathbf{x}_i^\\top \\mathbf{h}_1 - x'_i\n",
    "         \\end{bmatrix}\n",
    "         \\left(\n",
    "           \\mathtt{H}_{2 \\times 2} \\mathtt{H}_{2 \\times 2}^\\top + \\mathtt{I}\n",
    "         \\right)^{-1}\n",
    "         \\begin{bmatrix}\n",
    "           -\\mathbf{x}_i^\\top \\mathbf{h}_2 + y'_i\\\\\n",
    "           \\mathbf{x}_i^\\top \\mathbf{h}_1 - x'_i\n",
    "         \\end{bmatrix}.\n",
    "\n",
    "(a)\n",
    "---\n",
    "\n",
    "Abstracting away the terms that are not related to :math:`h_{\\cdot 3}` yields\n",
    "\n",
    ".. math::\n",
    "\n",
    "   0 = \\frac{\\partial \\mathcal{D}_\\perp}{\\partial h_{23}}\n",
    "    &= \\frac{\\partial}{\\partial h_{23}}\n",
    "       \\sum_i \\sum_j \\sum_k a_{ijk} \\epsilon_{ij} \\epsilon_{ik}\n",
    "       & \\quad & a_{ijk} =\n",
    "                 \\left( \\mathtt{J}_i \\mathtt{J}_i^\\top \\right)^{-1}_{jk}\\\\\n",
    "    &= \\sum_i\n",
    "         a_{i11} \\frac{\\partial \\epsilon_{i1}^2}{\\partial h_{23}} +\n",
    "         2 a_{i21} \\epsilon_{i2} \\frac{\\partial \\epsilon_{i1}}{\\partial h_{23}}\n",
    "       & \\quad & a_{i12} = a_{i21}\\\\\n",
    "    &= \\sum_i\n",
    "         2 a_{i11}\n",
    "           \\left( -\\mathbf{x}_i^\\top \\mathbf{h}_2 + y'_i \\right) (-w_i) +\n",
    "         2 a_{i21} \\left( \\mathbf{x}_i^\\top \\mathbf{h}_1 - x'_i \\right) (-w_i)\\\\\n",
    "    &= (a_{11} h_{21} - a_{21} h_{11}) \\sum_i x_i +\n",
    "       (a_{11} h_{22} - a_{21} h_{12}) \\sum_i y_i +\n",
    "       a_{11} \\sum_i h_{23} -\n",
    "       a_{11} \\sum_i y'_i -\n",
    "       a_{21} \\sum_i h_{13} +\n",
    "       a_{21} \\sum_i x'_i\n",
    "       & \\quad & w_i = 1 \\text{ and } a_{ijk} = a_{jk} \\, \\forall i\\\\\n",
    "   a_{21} h_{13} &= a_{11} h_{23} +\n",
    "                    (a_{11} h_{21} - a_{21} h_{11}) \\bar{x}_i +\n",
    "                    (a_{11} h_{22} - a_{21} h_{12}) \\bar{y}_i +\n",
    "                    a_{21} \\bar{x}'_i - a_{11} \\bar{y}'_i\n",
    "\n",
    "and\n",
    "\n",
    ".. math::\n",
    "\n",
    "   0 = \\frac{\\partial \\mathcal{D}_\\perp}{\\partial h_{13}}\n",
    "    &= \\sum_i\n",
    "         a_{i22} \\frac{\\partial \\epsilon_{i2}^2}{\\partial h_{13}} +\n",
    "         2 a_{i12} \\epsilon_{i1} \\frac{\\partial \\epsilon_{i2}}{\\partial h_{13}}\n",
    "       & \\quad & a_{i12} = a_{i21}\\\\\n",
    "    &= \\sum_i\n",
    "         2 a_{i22}\n",
    "           \\left( \\mathbf{x}_i^\\top \\mathbf{h}_1 - x'_i \\right) (w_i) +\n",
    "         2 a_{i12} \\left( -\\mathbf{x}_i^\\top \\mathbf{h}_2 + y'_i \\right) (w_i)\\\\\n",
    "    &= (a_{22} h_{11} - a_{12} h_{21}) \\sum_i x_i +\n",
    "       (a_{22} h_{12} - a_{12} h_{22}) \\sum_i y_i +\n",
    "       a_{22} \\sum_i h_{13} -\n",
    "       a_{22} \\sum_i x'_i -\n",
    "       a_{12} \\sum_i h_{23} +\n",
    "       a_{12} \\sum_i y'_i\n",
    "       & \\quad & w_i = 1 \\text{ and } a_{jk} = a_{ijk}\\, \\forall i\\\\\n",
    "   a_{12} h_{23} &= a_{22} h_{13} +\n",
    "                    (a_{22} h_{11} - a_{12} h_{21}) \\bar{x}_i +\n",
    "                    (a_{22} h_{12} - a_{12} h_{22}) \\bar{y}_i -\n",
    "                    a_{22} \\bar{x}'_i + a_{12} \\bar{y}'_i.\n",
    "\n",
    "By inspection, translating the points so that the centroids\n",
    ":math:`\\bar{\\mathbf{x}}` and :math:`\\bar{\\mathbf{x}}'` are at the origin\n",
    "restricts :math:`h_{\\cdot 3}` to\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\boldsymbol{0}\n",
    "    &= \\begin{bmatrix} a_{22} & -a_{12}\\\\ -a_{21} & a_{11} \\end{bmatrix}\n",
    "       \\begin{bmatrix} h_{13}\\\\ h_{23} \\end{bmatrix}\\\\\n",
    "    &= \\frac{1}{a_{11} a_{22} - a_{12} a_{21}}\n",
    "       \\begin{bmatrix} a_{22} & -a_{12}\\\\ -a_{21} & a_{11} \\end{bmatrix}\n",
    "       \\begin{bmatrix} h_{13}\\\\ h_{23} \\end{bmatrix}\\\\\n",
    "    &= \\mathtt{J} \\mathtt{J}^\\top\n",
    "       \\begin{bmatrix} h_{13}\\\\ h_{23} \\end{bmatrix}\n",
    "       & \\quad & \\mathtt{J} \\mathtt{J}^\\top =\n",
    "                 \\mathtt{J}_i \\mathtt{J}_i^\\top \\, \\forall i.\n",
    "\n",
    "For nondegenerate affinities, :math:`\\mathtt{J} \\mathtt{J}^\\top` is\n",
    "nonsingular, so the nullspace is the set containing only the zero vector.\n",
    "\n",
    "(b)\n",
    "---\n",
    "\n",
    "A variety is the simultaneous zero-set of one or more multivariate polynomials\n",
    "defined in :math:`\\mathbb{R}^N`.\n",
    "\n",
    "For a given affinity :math:`\\mathtt{H}_{\\mathrm{A}}` (4.9), the image\n",
    "correspondences :math:`\\mathbf{x} \\iff \\mathbf{x}'` that satisfy\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\boldsymbol{0}\n",
    "    &= \\mathcal{C}_\\mathtt{H}\\left( \\mathbf{X} \\right)\n",
    "       & \\quad & \\text{(4.10) and (4.11)}\\\\\n",
    "    &= \\begin{bmatrix}\n",
    "         \\boldsymbol{0}^\\top & -w' \\mathbf{x}^\\top & y' \\mathbf{x}^\\top\\\\\n",
    "         w' \\mathbf{x}^\\top & \\boldsymbol{0}^\\top & -x' \\mathbf{x}^\\top\n",
    "       \\end{bmatrix}\n",
    "       \\begin{bmatrix}\n",
    "         \\mathbf{h}_1\\\\ \\mathbf{h}_2\\\\ \\mathbf{h}_3\n",
    "       \\end{bmatrix}\n",
    "       & \\quad & \\text{(4.3)}\\\\\n",
    "    &= \\begin{bmatrix}\n",
    "         y' - h_{21} x - h_{22} y - h_{23}\\\\\n",
    "         h_{11} x + h_{12} y + h_{13} - x'\n",
    "       \\end{bmatrix}\n",
    "       & \\quad & w' = w = 1\n",
    "\n",
    "define an algebraic variety :math:`\\mathcal{V}_\\mathtt{H} \\in \\mathbb{R}^4`\n",
    "which is the intersection of two hyperplanes.  Each hyperplane is in\n",
    ":math:`\\mathbb{R}^4` and represents a linear constraint.\n",
    "\n",
    "Recall that the intersection of two hyperplanes in :math:`\\mathbb{R}^n` defines\n",
    "a linear subspace of dimension :math:`n - 2`, which could be interpreted as the\n",
    "space of free variables.  By definition of codimension,\n",
    ":math:`\\mathcal{V}_\\mathtt{H}` is a codimension-2 subspace of\n",
    ":math:`\\mathbb{R}^4`.\n",
    "\n",
    "To prove the sufficient condition, suppose :math:`\\mathbf{X}` lies on\n",
    ":math:`\\mathcal{V}_\\mathtt{H}` and\n",
    ":math:`\\mathtt{H}_{2 \\times 2} \\mathbf{x} - \\mathbf{x}' \\neq \\boldsymbol{0}`.\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\boldsymbol{0}\n",
    "    &= \\mathcal{C}_\\mathtt{H}\\left( \\mathbf{X} \\right)\\\\\n",
    "    &= \\begin{bmatrix}\n",
    "         h_{11} x + h_{12} y + h_{13} - x'\\\\\n",
    "         h_{21} x + h_{22} y + h_{23} - y'\n",
    "       \\end{bmatrix}\n",
    "       & \\quad & \\text{negated and swapped first row of (4.3)}\\\\\n",
    "    &= \\mathtt{H}_{2 \\times 2} \\mathbf{x} - \\mathbf{x}' +\n",
    "       \\begin{bmatrix} h_{13}\\\\ h_{23} \\end{bmatrix}\\\\\n",
    "    &= \\mathtt{H}_{2 \\times 2} \\mathbf{x} - \\mathbf{x}'\n",
    "\n",
    "holds according to (a), but this contradicts the initial assumption that\n",
    ":math:`\\mathtt{H}_{2 \\times 2} \\mathbf{x} - \\mathbf{x}' \\neq \\boldsymbol{0}`.\n",
    "\n",
    "To prove the necessary condition, suppose\n",
    ":math:`\\mathtt{H}_{2 \\times 2} \\mathbf{x} - \\mathbf{x}' = \\boldsymbol{0}` and\n",
    ":math:`\\mathbf{X}` does not lie on :math:`\\mathcal{V}_\\mathtt{H}`.\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathcal{C}_\\mathtt{H}\\left( \\mathbf{X} \\right)\n",
    "    &= \\mathtt{H}_{2 \\times 2} \\mathbf{x} - \\mathbf{x}' +\n",
    "       \\begin{bmatrix} h_{13}\\\\ h_{23} \\end{bmatrix}\n",
    "       & \\quad & \\text{negated and swapped first row of (4.3)}\\\\\n",
    "    &= \\begin{bmatrix} h_{13}\\\\ h_{23} \\end{bmatrix}\\\\\n",
    "    &= \\boldsymbol{0}\n",
    "\n",
    "holds according to (a), but this contradicts the initial assumption that\n",
    ":math:`\\mathbf{X}` does not lie on :math:`\\mathcal{V}_\\mathtt{H}`.\n",
    "\n",
    "(c)\n",
    "---\n",
    "\n",
    "According to (b), any codimension-2 subspace may be expressed as\n",
    ":math:`\\left[\n",
    "\\begin{array}{c|c} \\mathtt{H}_{2 \\times 2} & -\\mathtt{I} \\end{array} \\right]\n",
    "\\mathbf{X} = \\boldsymbol{0}`.\n",
    "\n",
    "Section 4.2.5 shows that the task of estimating the homography\n",
    ":math:`\\hat{\\mathtt{H}}` and points :math:`\\hat{\\mathbf{x}}_i` and\n",
    ":math:`\\hat{\\mathbf{x}}_i'` that minimizes (4.8) is equivalent to finding a\n",
    "variety :math:`\\mathcal{V}_\\mathtt{H}` that passes through the points\n",
    ":math:`\\mathbf{X}_i`.\n",
    "\n",
    "Therefore, the estimation task is equivalent to finding the best-fitting\n",
    "codimension-2 subspace.\n",
    "\n",
    "(d)\n",
    "---\n",
    "\n",
    "The matrix :math:`\\mathtt{M}` with rows :math:`\\mathbf{X}_i^\\top` has a rank\n",
    "of :math:`4`.  According to (c), the codimension of best fitting subspace is\n",
    ":math:`2`.  Here best means minimize the sum of the squares of the perpendicular\n",
    "distances of the points to the subspace.\n",
    "\n",
    "Since the (right) singular vectors :math:`\\mathbf{V}_1` and :math:`\\mathbf{V}_2`\n",
    "correspond to the two largest singular values of :math:`\\mathtt{M}` and\n",
    "form an orthonormal basis, Theorem 4.1 in :cite:`hopcroft2012computer`\n",
    "guarantees that :math:`\\mathcal{V}_\\mathtt{H}` spanned by\n",
    ":math:`\\mathbf{V}_1, \\mathbf{V}_2` is the best-fit :math:`2`-dimensional\n",
    "subspace for :math:`\\mathtt{M}`.\n",
    "\n",
    "(e)\n",
    "---\n",
    "\n",
    "Since :math:`\\mathcal{V}_{\\mathtt{H}}` is spanned by :math:`\\mathbf{V}_1` and\n",
    ":math:`\\mathbf{V}_2`, each point that lies on :math:`\\mathcal{V}_{\\mathtt{H}}`\n",
    "can be expressed as\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathbf{X} =\n",
    "   \\begin{bmatrix} \\mathbf{V}_1 & \\mathbf{V}_2 \\end{bmatrix} \\mathbf{t}\n",
    "\n",
    "where :math:`\\mathbf{t} \\in \\mathbb{R}^2`.  By (b) and (c), each point must also\n",
    "satisfy\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\left[\n",
    "     \\begin{array}{c|c} \\mathtt{H}_{2 \\times 2} & -\\mathtt{I} \\end{array}\n",
    "   \\right] \\mathbf{X} =\n",
    "   \\left[\n",
    "     \\begin{array}{c|c} \\mathtt{H}_{2 \\times 2} & -\\mathtt{I} \\end{array}\n",
    "   \\right]\n",
    "     \\begin{bmatrix} \\mathbf{V}_1 & \\mathbf{V}_2 \\end{bmatrix} \\mathbf{t} =\n",
    "   \\boldsymbol{0}.\n",
    "\n",
    "For non-trivial solutions where :math:`\\mathbf{t} \\neq \\boldsymbol{0}`,\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\left[\n",
    "     \\begin{array}{c|c} \\mathtt{H}_{2 \\times 2} & -\\mathtt{I} \\end{array}\n",
    "   \\right]\n",
    "     \\begin{bmatrix} \\mathbf{V}_1 & \\mathbf{V}_2 \\end{bmatrix}\n",
    "    &= \\boldsymbol{0}\\\\\n",
    "   \\mathtt{H}_{2 \\times 2} \\mathtt{B}\n",
    "    &= \\mathtt{C}\n",
    "       & \\quad & \\begin{bmatrix} \\mathbf{V}_1 & \\mathbf{V}_2 \\end{bmatrix} =\n",
    "                 \\begin{bmatrix} \\mathtt{B}\\\\ \\mathtt{C} \\end{bmatrix}\\\\\n",
    "   \\mathtt{H}_{2 \\times 2} &= \\mathtt{C} \\mathtt{B}^{-1}.\n",
    "\n",
    "The desired affinity can be derived as\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathbf{x}'_i + \\mathbf{t}'\n",
    "    &= \\mathtt{H}_{2 \\times 2} \\left( \\mathbf{x}_i + \\mathbf{t} \\right)\n",
    "       & \\quad & \\text{(a)}\\\\\n",
    "   \\mathbf{x}'_i\n",
    "    &= \\mathtt{H}_{2 \\times 2} \\left( \\mathbf{x}_i + \\mathbf{t} \\right) -\n",
    "       \\mathbf{t}'\\\\\n",
    "   \\begin{bmatrix} \\mathbf{x}'_i\\\\ 1 \\end{bmatrix}\n",
    "    &= \\mathtt{H}_{\\mathtt{A}}\n",
    "       \\begin{bmatrix} \\mathbf{x}_i\\\\ 1 \\end{bmatrix}\n",
    "\n",
    "where\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathtt{H}_{\\mathtt{A}} =\n",
    "   \\begin{bmatrix}\n",
    "     \\mathtt{H}_{2 \\times 2} &\n",
    "       \\mathtt{H}_{2 \\times 2} \\mathbf{t} - \\mathbf{t}'\\\\\n",
    "     \\boldsymbol{0}^\\top & 1\n",
    "   \\end{bmatrix}\n",
    "\n",
    "and\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\hat{\\mathbf{X}}_i\n",
    "    &= \\mathbf{X}_i + \\boldsymbol{\\delta}_{\\mathbf{X}_i}\\\\\n",
    "    &= \\begin{bmatrix}\n",
    "         \\mathtt{B} \\mathtt{B}^\\top & \\mathtt{B} \\mathtt{C}^\\top\\\\\n",
    "         \\mathtt{C} \\mathtt{B}^\\top & \\mathtt{C} \\mathtt{C}^\\top\n",
    "       \\end{bmatrix}\n",
    "       \\mathbf{X}_i\n",
    "       & \\quad & \\text{(e.1)}\\\\\n",
    "    &= \\begin{bmatrix} \\mathtt{B}\\\\ \\mathtt{C} \\end{bmatrix}\n",
    "       \\begin{bmatrix} \\mathtt{B}^\\top & \\mathtt{C}^\\top \\end{bmatrix}\n",
    "       \\mathbf{X}_i\\\\\n",
    "    &= \\begin{bmatrix} \\mathbf{V}_1 & \\mathbf{V}_2 \\end{bmatrix}\n",
    "       \\begin{bmatrix} \\mathbf{V}_1^\\top\\\\ \\mathbf{V}_2^\\top \\end{bmatrix}\n",
    "       \\mathbf{X}_i\\\\\n",
    "    &= \\left( \\sum_{i = 1}^2 \\mathbf{V}_i \\mathbf{V}_i^\\top \\right)\n",
    "       \\mathbf{X}_i.\n",
    "\n",
    "(e.1)\n",
    "^^^^^\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\boldsymbol{\\delta}_{\\mathbf{X}_i}\n",
    "    &= -\\mathtt{J}^\\top\n",
    "       \\left( \\mathtt{J} \\mathtt{J}^\\top \\right)^{-1}\n",
    "       \\boldsymbol{\\epsilon}_i\n",
    "       & \\quad & \\text{(4.11)}\\\\\n",
    "    &= -\\begin{bmatrix} \\mathtt{H}_{2 \\times 2}\\\\ -\\mathtt{I} \\end{bmatrix}\n",
    "       \\left(\n",
    "         \\mathtt{I} + \\mathtt{H}_{2 \\times 2} \\mathtt{H}_{2 \\times 2}^\\top\n",
    "       \\right)^{-1}\n",
    "       \\begin{bmatrix} \\mathtt{H}_{2 \\times 2} & -\\mathtt{I} \\end{bmatrix}\n",
    "       \\mathbf{X}_i\\\\\n",
    "    &= -\\begin{bmatrix}\n",
    "         \\mathtt{H}_{2 \\times 2}^\\top (\\bullet) \\mathtt{H}_{2 \\times 2} &\n",
    "           -\\mathtt{H}_{2 \\times 2}^\\top (\\bullet)\\\\\n",
    "         -(\\bullet) \\mathtt{H}_{2 \\times 2}^\\top & (\\bullet)\n",
    "       \\end{bmatrix} \\mathbf{X}_i\n",
    "       & \\quad & \\text{(e.2) and } \\bullet =\n",
    "                                   \\mathtt{I} - \\mathtt{C} \\mathtt{C}^\\top\\\\\n",
    "    &= \\left(\n",
    "         \\begin{bmatrix}\n",
    "           \\mathtt{B} \\mathtt{B}^\\top & \\mathtt{B} \\mathtt{C}^\\top\\\\\n",
    "           \\mathtt{C} \\mathtt{B}^\\top & \\mathtt{C} \\mathtt{C}^\\top\n",
    "         \\end{bmatrix} -\n",
    "         \\mathtt{I}\n",
    "       \\right) \\mathbf{X}_i\n",
    "       & \\quad & \\text{(e.3), (e.4), (e.5), and (e.6)}\n",
    "\n",
    "(e.2)\n",
    "^^^^^\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\left(\n",
    "     \\mathtt{I} + \\mathtt{H}_{2 \\times 2} \\mathtt{H}_{2 \\times 2}^\\top\n",
    "   \\right)^{-1}\n",
    "    &= \\mathtt{I} -\n",
    "       \\mathtt{H}_{2 \\times 2} \\left(\n",
    "         \\mathtt{I} + \\mathtt{H}_{2 \\times 2}^\\top \\mathtt{H}_{2 \\times 2}\n",
    "       \\right)^{-1} \\mathtt{H}_{2 \\times 2}^\\top\n",
    "       & \\quad & \\text{Woodbury matrix identity}\\\\\n",
    "    &= \\mathtt{I} -\n",
    "       \\mathtt{H}_{2 \\times 2}\n",
    "         \\mathtt{B} \\mathtt{B}^\\top \\mathtt{H}_{2 \\times 2}^\\top\n",
    "       & \\quad & \\text{(e.3)}\\\\\n",
    "    &= \\mathtt{I} - \\mathtt{C} \\mathtt{C}^\\top\n",
    "       & \\quad & \\mathtt{H}_{2 \\times 2} = \\mathtt{C} \\mathtt{B}^{-1}\n",
    "\n",
    "(e.3)\n",
    "^^^^^\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathtt{I}\n",
    "    &= \\begin{bmatrix} \\mathbf{V}_1^\\top\\\\ \\mathbf{V}_2^\\top \\end{bmatrix}\n",
    "       \\begin{bmatrix} \\mathbf{V}_1 & \\mathbf{V}_2 \\end{bmatrix}\\\\\n",
    "    &= \\begin{bmatrix} \\mathtt{B}^\\top & \\mathtt{C}^\\top \\end{bmatrix}\n",
    "       \\begin{bmatrix} \\mathtt{B}\\\\ \\mathtt{C} \\end{bmatrix}\\\\\n",
    "    &= \\mathtt{B}^\\top \\mathtt{B} + \\mathtt{C}^\\top \\mathtt{C}\\\\\n",
    "   \\mathtt{B}^{-\\top} \\mathtt{B}^{-1}\n",
    "    &= \\mathtt{I} +\n",
    "       \\mathtt{B}^{-\\top} \\mathtt{C}^\\top \\mathtt{C} \\mathtt{B}^{-1}\\\\\n",
    "    &= \\mathtt{I} + \\mathtt{H}_{2 \\times 2}^\\top \\mathtt{H}_{2 \\times 2}\n",
    "\n",
    "(e.4)\n",
    "^^^^^\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\mathtt{H}_{2 \\times 2}^\\top (\\bullet) \\mathtt{H}_{2 \\times 2}\n",
    "    &= \\mathtt{B}^{-\\top} \\mathtt{C}^\\top\n",
    "       \\left( \\mathtt{I} - \\mathtt{C} \\mathtt{C}^\\top \\right)\n",
    "       \\mathtt{C} \\mathtt{B}^{-1}\n",
    "       & \\quad & \\text{(e.2)}\\\\\n",
    "    &= \\mathtt{B}^{-\\top} \\mathtt{C}^\\top \\mathtt{C} \\mathtt{B}^\\top\n",
    "       & \\quad & \\mathtt{B}^{-\\top} \\mathtt{C}^\\top \\mathtt{C}\n",
    "                   \\mathtt{I} \\mathtt{B}^{-1} =\n",
    "                 \\mathtt{B}^{-\\top} \\mathtt{C}^\\top \\mathtt{C}\n",
    "                   \\mathtt{B}^\\top \\mathtt{B} \\mathtt{B}^{-1} +\n",
    "                 \\mathtt{B}^{-\\top} \\mathtt{C}^\\top \\mathtt{C}\n",
    "                   \\mathtt{C}^\\top \\mathtt{C} \\mathtt{B}^{-1}\\\\\n",
    "    &= \\mathtt{I} - \\mathtt{B} \\mathtt{B}^\\top\n",
    "       & \\quad & \\mathtt{B}^{-\\top} \\mathtt{I} \\mathtt{B}^\\top =\n",
    "                 \\mathtt{B}^{-\\top} \\mathtt{B}^\\top \\mathtt{B} \\mathtt{B}^\\top +\n",
    "                 \\mathtt{B}^{-\\top} \\mathtt{C}^\\top \\mathtt{C} \\mathtt{B}^\\top\n",
    "\n",
    "(e.5)\n",
    "^^^^^\n",
    "\n",
    ".. math::\n",
    "\n",
    "   -\\mathtt{H}_{2 \\times 2}^\\top (\\bullet)\n",
    "    &= -\\mathtt{B}^{-\\top} \\mathtt{C}^\\top\n",
    "       \\left( \\mathtt{I} - \\mathtt{C} \\mathtt{C}^\\top \\right)\n",
    "       & \\quad & \\text{(e.2)}\\\\\n",
    "    &= -\\mathtt{B} \\mathtt{C}^\\top\n",
    "       & \\quad & \\mathtt{B}^{-\\top} \\mathtt{I} \\mathtt{C}^{\\top} =\n",
    "                 \\mathtt{B}^{-\\top} \\mathtt{B}^\\top\n",
    "                   \\mathtt{B} \\mathtt{C}^{\\top} +\n",
    "                 \\mathtt{B}^{-\\top} \\mathtt{C}^\\top\n",
    "                   \\mathtt{C} \\mathtt{C}^{\\top}\n",
    "\n",
    "(e.6)\n",
    "^^^^^\n",
    "\n",
    ".. math::\n",
    "\n",
    "   -(\\bullet) \\mathtt{H}_{2 \\times 2}^\\top\n",
    "    &= -\\left( \\mathtt{I} - \\mathtt{C} \\mathtt{C}^\\top \\right)\n",
    "       \\mathtt{C} \\mathtt{B}^{-1}\n",
    "       & \\quad & \\text{(e.2)}\\\\\n",
    "    &= -\\mathtt{C} \\mathtt{B}^\\top\n",
    "       & \\quad & \\mathtt{C} \\mathtt{I} \\mathtt{B}^{-1} =\n",
    "                 \\mathtt{C} \\mathtt{B}^\\top \\mathtt{B} \\mathtt{B}^{-1} +\n",
    "                 \\mathtt{C} \\mathtt{C}^\\top \\mathtt{C} \\mathtt{B}^{-1}"
   ]
  },
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    "(ix) Computing Homographies of :math:`\\mathbb{P}^3` from Line Correspondences\n",
    "=============================================================================\n",
    "\n",
    "Invariants are measurements that remain fixed under collineations.  The book\n",
    "incorrectly references :cite:`hartley1994projective` instead of\n",
    ":cite:`hartley1993invariants` for the discussion of isotropy subgroups.\n",
    ":cite:`hartley1993invariants` considers invariants that can be derived from two\n",
    "views of an object.  The alternative is to consider constrained sets of points\n",
    "(e.g. solids of revolution) because no invariants of arbitrary point sets in\n",
    "3-dimensions may be computed from a single image.\n",
    "\n",
    "The invariants of lines in space can not be computed from two views of lines\n",
    "only.  Given two images of a line and two arbitrary cameras, there is always a\n",
    "line in space that corresponds to the two images.  Unless the epipolar geometry\n",
    "of the two views is known, two images of an unknown line do not in any way\n",
    "constrain the cameras.\n",
    "\n",
    "Given four lines in :math:`\\mathcal{P}^3` in general positions, there exist\n",
    "exactly two transverse lines that meet all four of these lines.  The cross ratio\n",
    "of the points of intersection of lines with each of the transverse lines give\n",
    "two independent projective invariants of the set of four lines.  One algebraic\n",
    "way of defining the invariants of four lines is as a homogeneous vector\n",
    "\n",
    ".. math::\n",
    "\n",
    "   I(\\lambda_1, \\lambda_2, \\lambda_3, \\lambda_4) =\n",
    "   \\left(\n",
    "     \\left\\vert \\lambda_1 \\lambda_2 \\right\\vert,\n",
    "     \\left\\vert \\lambda_3 \\lambda_4 \\right\\vert,\n",
    "     \\left\\vert \\lambda_1 \\lambda_3 \\right\\vert,\n",
    "     \\left\\vert \\lambda_2 \\lambda_4 \\right\\vert,\n",
    "     \\left\\vert \\lambda_1 \\lambda_4 \\right\\vert,\n",
    "     \\left\\vert \\lambda_2 \\lambda_3 \\right\\vert\n",
    "   \\right)\n",
    "   \\quad \\text{where} \\quad\n",
    "   \\left\\vert \\lambda_i \\lambda_j \\right\\vert =\n",
    "   \\det\\left( \\begin{bmatrix} \\lambda_i & \\lambda_j \\end{bmatrix} \\right).\n",
    "\n",
    "Two such computed invariants are deemed equal if they differ by a scalar factor.\n",
    "One application of this formulation is\n",
    ":math:`\\text{Pl}\\mathrm{\\ddot{u}}\\text{cker}`\n",
    ":doc:`line coordinates </nb/multiple-view-geometry-hz/chapter-03>` (3.13).\n",
    "\n",
    ":math:`\\left\\vert \\lambda_i \\lambda_j \\right\\vert` will vanish if and only if\n",
    "the four points involved are coplanar i.e. when the two lines are coincident.\n",
    "The proposed definition of the invariant avoids the (near-)vanishing denominator\n",
    "problems of cross ratios.  However, if three of the determinants vanish, then\n",
    "the invariant is undefined. This occurs when\n",
    "\n",
    "#. Three of the lines lie in a plane.\n",
    "#. One of the lines meets all the other three.\n",
    "\n",
    "The configuration where one line meets two of the other lines is not degenerate,\n",
    "but is not useful because two of the determinants vanish.  Any two such\n",
    "configurations cannot be distinguished and are equivalent under collineation.\n",
    "\n",
    "A configuration of four lines in :math:`\\mathbb{P}^3` is degenerate because\n",
    "there is a one-parameter subgroup of projectivities fixing the four lines.  This\n",
    "reduces the number of degrees of freedom of the projectivities of\n",
    ":math:`\\mathbb{P}^3` on sets of four lines in space to 14, which explains why\n",
    "there are two independent invariants (result 2.16).\n",
    "\n",
    "There is no natural or canonical way to fix the coordinate system by specifying\n",
    "line coordinates.  To fix a basis using lines will lead to the use of a maximum\n",
    "of three lines which have in total :math:`3 \\times 4 = 12` degrees of freedom.\n",
    "The other degrees of freedom must be determined by the cameras or another point.\n",
    ":cite:`oskarsson2004minimal` observed that a well-defined parameterization of\n",
    "structure and motion problems must satisfy\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\boldsymbol{\\pi}_i^\\top \\mathtt{H} \\mathbf{X}_j = 0\n",
    "   \\qquad\n",
    "   i = 1, 2; j = 1, 2\n",
    "\n",
    "where :math:`\\mathtt{H}` transfers a line defined by the two points\n",
    ":math:`(\\mathbf{X}_1`, :math:`\\mathbf{X}_2)` to a line defined by the\n",
    "intersection of the two planes\n",
    ":math:`(\\boldsymbol{\\pi}_1`, :math:`\\boldsymbol{\\pi}_2)`."
   ]
  },
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    ".. rubric:: References\n",
    "\n",
    ".. bibliography:: chapter-04.bib"
   ]
  }
 ],
 "metadata": {
  "anaconda-cloud": {},
  "celltoolbar": "Raw Cell Format",
  "kernelspec": {
   "display_name": "Python [default]",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.5.2"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 1
}

{
 "cells": [
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    "********************\n",
    "Parameter Estimation\n",
    "********************"
   ]
  },
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    "(i)\n",
    "===\n",
    "\n",
    "A change of coordinates in the parameter space is also known as\n",
    "reparameterization, which is usually realized through the\n",
    "`change-of-variable technique`_.\n",
    "\n",
    ".. _change-of-variable technique: https://onlinecourses.science.psu.edu/stat414/node/157\n",
    "\n",
    "Let :math:`X` be a continuous random variable with generic probability\n",
    "density function :math:`f(x)` defined over the support\n",
    ":math:`c_1 \\leq x \\leq c_2`, and let :math:`Y = u(X)` be an invertible function\n",
    "of :math:`X` with inverse function :math:`X = v(Y)`.  The probability density\n",
    "function of :math:`Y` is\n",
    "\n",
    ".. math::\n",
    "\n",
    "   f_Y(y) = f_X(v(y)) \\left\\vert v'(y) \\right\\vert\n",
    "\n",
    "defined over the support :math:`u(c_1) \\leq y \\leq u(c_2)`.\n",
    "\n",
    "Consider the Bernoulli distribution with a uniform prior such that\n",
    "\n",
    ".. math::\n",
    "\n",
    "   p(x_i \\mid \\mu)\n",
    "    &= \\mu^{x_i} (1 - \\mu)^{1 - x_i}\n",
    "       & \\quad & x_i \\in \\{0, 1\\},\\\\\\\\\n",
    "   p_X(\\mu)\n",
    "    &= 1\n",
    "       & \\quad & c_1 = 0, c_1 = 1, \\mu \\in [0, 1].\n",
    "\n",
    "The maximum a posteriori (MAP) estimation is\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\DeclareMathOperator*{\\argmax}{arg\\,max}\n",
    "   \\hat{\\mu}_{\\mathrm{MAP}}\n",
    "    &= \\argmax_\\mu p(\\mu \\mid X)\\\\\n",
    "    &= \\argmax_\\mu \\log p_X(\\mu) + \\sum_{x_i \\in X} \\log p(x_i \\mid \\mu)\\\\\n",
    "    &= \\argmax_\\mu \\sum_{i = 1}^n x_i \\log \\mu + (1 - x_i) \\log(1 - \\mu)\\\\\n",
    "    &= \\frac{1}{n} \\sum_i x_i\\\\\n",
    "    &= \\hat{\\mu}_{\\mathrm{ML}}.\n",
    "\n",
    "The following derivations demonstrate that the mode (MAP estimate) and mean of\n",
    "the posterior distribution are not invariant to reparameterization.\n",
    "\n",
    "Parameterization I\n",
    "------------------\n",
    "\n",
    "Now define :math:`\\theta = u(\\mu) = \\sqrt{\\mu}` and\n",
    ":math:`\\mu = v(\\theta) = \\theta^2`.  The support happens to be the same for this\n",
    "parameterization.  The new prior is\n",
    "\n",
    ".. math::\n",
    "\n",
    "   p_Y(\\theta)\n",
    "    &= p_X(v(\\theta)) \\left\\vert v'(\\theta) \\right\\vert\\\\\n",
    "    &= p_X(\\theta^2) \\left\\vert 2 \\theta \\right\\vert\n",
    "       & \\quad & v'(\\theta) = \\frac{\\partial}{\\partial \\theta} v(\\theta)\\\\\n",
    "    &= 2 \\theta\n",
    "       & \\quad & \\theta \\in [0, 1].\n",
    "\n",
    "The reparameterized MAP estimation is\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\hat{\\theta}_{\\mathrm{MAP}}\n",
    "    &= \\argmax_\\theta p(\\theta \\mid X)\\\\\n",
    "    &= \\argmax_\\theta \\frac{p(X \\mid \\theta) p_Y(\\theta)}{p(X)}\\\\\n",
    "    &= \\argmax_\\theta \\log p_Y(\\theta) +\n",
    "       \\sum_{x_i \\in X} \\log p(x_i \\mid \\theta)\n",
    "       & \\quad & p(X) = \\mathrm{const}\\\\\n",
    "    &= \\argmax_\\theta \\log 2 \\theta +\n",
    "       \\sum_{i = 1}^n x_i \\log \\theta + (1 - x_i) \\log(1 - \\theta)\\\\\n",
    "    &= \\frac{1 + \\sum_i x_i}{n + 1}\\\\\n",
    "    &\\neq u\\left( \\hat{\\mu}_{\\mathrm{MAP}} \\right).\n",
    "\n",
    "The mean of the posterior distribution is\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\DeclareMathOperator*{\\argmin}{arg\\,min}\n",
    "   \\hat{\\theta}(x = 1)\n",
    "    &= \\left\\langle \\theta \\right\\rangle_{p(\\theta \\mid x = 1)}\n",
    "       & \\quad & \\text{(ii)}\\\\\n",
    "    &= \\int \\theta p(\\theta \\mid x = 1) d\\theta\\\\\n",
    "    &= \\int \\theta\n",
    "            \\frac{\n",
    "              p(x = 1 \\mid \\theta) p_Y(\\theta)\n",
    "            }{\n",
    "              \\int p(x = 1 \\mid \\theta') p_Y(\\theta') d\\theta'\n",
    "            }\n",
    "            d\\theta\\\\\n",
    "    &= \\int \\frac{\n",
    "              \\theta (\\theta) (2 \\theta)\n",
    "            }{\n",
    "              \\int \\theta' (2 \\theta') d\\theta'\n",
    "            }\n",
    "            d\\theta\\\\\n",
    "    &= \\frac{3}{2} \\int 2 \\theta^3 d\\theta\n",
    "       & \\quad & \\int \\theta' (2 \\theta') d\\theta' = \\frac{2}{3}\\\\\n",
    "    &= \\frac{3}{4}\n",
    "       & \\quad & \\int 2 \\theta^3 d\\theta = \\frac{1}{2}.\n",
    "\n",
    "Parameterization II\n",
    "-------------------\n",
    "\n",
    "Now define :math:`\\phi = u(\\mu) = 1 - \\sqrt{1 - \\mu}` and\n",
    ":math:`\\mu = v(\\phi) = 1 - (1 - \\phi)^2`.  The support happens to be the same\n",
    "for this parameterization.  The new prior is\n",
    "\n",
    ".. math::\n",
    "\n",
    "   p_Y(\\phi)\n",
    "    &= p_X(v(\\phi)) \\left\\vert v'(\\phi) \\right\\vert\\\\\n",
    "    &= p_X\\left( 1 - (1 - \\phi)^2 \\right) \\left\\vert 2 (1 - \\phi) \\right\\vert\n",
    "       & \\quad & v'(\\phi) = \\frac{\\partial}{\\partial \\phi} v(\\phi)\\\\\n",
    "    &= 2 - 2 \\phi\n",
    "       & \\quad & \\phi \\in [0, 1].\n",
    "\n",
    "The reparameterized MAP estimation is\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\hat{\\phi}_{\\mathrm{MAP}}\n",
    "    &= \\argmax_\\phi p(\\phi \\mid X)\\\\\n",
    "    &= \\argmax_\\phi \\frac{p(X \\mid \\phi) p_Y(\\phi)}{p(X)}\\\\\n",
    "    &= \\argmax_\\phi \\log p_Y(\\phi) +\n",
    "       \\sum_{x_i \\in X} \\log p(x_i \\mid \\phi)\n",
    "       & \\quad & p(X) = \\mathrm{const}\\\\\n",
    "    &= \\argmax_\\phi \\log 2 (1 - \\phi) +\n",
    "       \\sum_{i = 1}^n x_i \\log \\phi + (1 - x_i) \\log(1 - \\phi)\\\\\n",
    "    &= \\frac{1}{n + 1} \\sum_i x_i\\\\\n",
    "    &\\neq u\\left( \\hat{\\mu}_{\\mathrm{MAP}} \\right).\n",
    "\n",
    "The mean of the posterior distribution is\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\hat{\\phi}(x = 1)\n",
    "    &= \\left\\langle \\phi \\right\\rangle_{p(\\phi \\mid x = 1)}\n",
    "       & \\quad & \\text{(ii)}\\\\\n",
    "    &= \\int \\phi p(\\phi \\mid x = 1) d\\phi\\\\\n",
    "    &= \\int \\phi\n",
    "            \\frac{\n",
    "              p(x = 1 \\mid \\phi) p_Y(\\phi)\n",
    "            }{\n",
    "              \\int p(x = 1 \\mid \\phi') p_Y(\\phi') d\\phi'\n",
    "            }\n",
    "            d\\phi\\\\\n",
    "    &= \\int \\frac{\n",
    "              \\phi (\\phi) (2 - 2 \\phi)\n",
    "            }{\n",
    "              \\int \\phi' (2 - \\phi') d\\phi'\n",
    "            }\n",
    "            d\\phi\\\\\n",
    "    &= 3 \\int 2 \\phi^2 - 2 \\phi^3 d\\phi\n",
    "       & \\quad & \\int \\phi' (2 - \\phi') d\\phi' = \\frac{1}{3}\\\\\n",
    "    &= \\frac{1}{2}\n",
    "       & \\quad & \\int 2 \\phi^2 - 2 \\phi^3 d\\phi = \\frac{1}{6}."
   ]
  },
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    "(ii)\n",
    "====\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\argmin_Y Q\n",
    "    &= \\argmin_Y \\int \\left\\Vert Y - \\theta \\right\\Vert^2_2 p(\\theta) d\\theta\\\\\n",
    "    &= \\argmin_Y \\int (Y - \\theta)^\\top (Y - \\theta) p(\\theta) d\\theta\n",
    "       & \\quad & \\theta \\in \\mathbb{R}^n\\\\\n",
    "   0 &= \\int \\frac{\\partial}{\\partial Y} (Y - \\theta)^\\top (Y - \\theta)\n",
    "             p(\\theta) d\\theta\n",
    "        & \\quad & \\text{differentiation under the integral sign}\\\\\n",
    "    &= \\int 2 (Y - \\theta) p(\\theta) d\\theta\n",
    "       & \\quad & \\text{Matrix Cookbook (85)}\\\\\n",
    "    &= Y \\int p(\\theta) d\\theta - \\int \\theta p(\\theta) d\\theta\\\\\n",
    "   Y &= \\left\\langle \\theta \\right\\rangle_{p(\\theta)}\n",
    "        & \\quad & \\int p(\\theta) d\\theta = 1.\n",
    "\n",
    "To see that this is the minimum, notice that\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\frac{\\partial^2 Q}{\\partial Y^2}\n",
    "    &= \\frac{\\partial}{\\partial Y} \\int 2 (Y - \\theta) p(\\theta) d\\theta\\\\\n",
    "    &= 2 \\mathbf{I}\n",
    "       & \\quad & \\text{Leibniz integral rule}\\\\\n",
    "    &\\succ \\boldsymbol{0}."
   ]
  },
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    ".. _hartley2004-ex-a3.iii:\n",
    "\n",
    "(iii)\n",
    "=====\n",
    "\n",
    "Given\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\argmin_Y Q\n",
    "    &= \\argmin_Y \\int \\left\\vert Y - \\theta \\right\\vert p(\\theta) d\\theta\n",
    "       & \\quad & \\theta \\in \\mathbb{R}\\\\\n",
    "    &= \\argmin_Y\n",
    "         \\int_L^Y (Y - \\theta) p(\\theta) d\\theta +\n",
    "         \\int_Y^U (\\theta - Y) p(\\theta) d\\theta,\n",
    "\n",
    "the minimum is reached when\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\frac{\\partial}{\\partial Y} \\argmin_Y Q\n",
    "    &= \\left(\n",
    "         (Y - Y) p(Y) \\frac{\\partial}{\\partial Y} Y -\n",
    "         (Y - L) p(L) \\frac{\\partial}{\\partial Y} L +\n",
    "         \\int_L^Y \\frac{\\partial}{\\partial Y} (Y - \\theta) p(\\theta) d\\theta\n",
    "       \\right) +\\\\\n",
    "    &\\qquad\n",
    "       \\left(\n",
    "         (U - Y) p(U) \\frac{\\partial}{\\partial Y} U -\n",
    "         (Y - Y) p(Y) \\frac{\\partial}{\\partial Y} Y -\n",
    "         \\int_Y^U \\frac{\\partial}{\\partial Y} (\\theta - Y) p(\\theta) d\\theta\n",
    "       \\right)\n",
    "        & \\quad & \\text{differentiation under the integral sign}\\\\\n",
    "   0 &= \\int_L^Y p(\\theta) d\\theta - \\int_Y^U p(\\theta) d\\theta.\n",
    "\n",
    "When :math:`L \\rightarrow -\\infty` and :math:`U \\rightarrow \\infty`,\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\int_{-\\infty}^Y p(\\theta) d\\theta\n",
    "    &= \\int_Y^{\\infty} p(\\theta) d\\theta\\\\\n",
    "   p(X \\leq Y)\n",
    "    &= p(X \\geq Y)\n",
    "       & \\quad & \\text{by definition of median, CDF, and CCDF.}\n",
    "\n",
    "To verify that this is the minimum, notice that\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\frac{\\partial^2 Q}{\\partial Y^2}\n",
    "    &= \\frac{\\partial}{\\partial Y}\n",
    "       \\left(\n",
    "         \\int_L^Y p(\\theta) d\\theta - \\int_Y^U p(\\theta) d\\theta\n",
    "       \\right)\\\\\n",
    "    &= \\left(\n",
    "         p(Y) \\frac{\\partial}{\\partial Y} Y -\n",
    "         p(L) \\frac{\\partial}{\\partial Y} L +\n",
    "         \\int_L^Y \\frac{\\partial}{\\partial Y} p(\\theta) d\\theta\n",
    "       \\right) -\\\\\n",
    "    &\\qquad\n",
    "       \\left(\n",
    "         p(U) \\frac{\\partial}{\\partial Y} U -\n",
    "         p(Y) \\frac{\\partial}{\\partial Y} Y -\n",
    "         \\int_Y^U \\frac{\\partial}{\\partial Y} p(\\theta) d\\theta\n",
    "       \\right)\n",
    "       & \\quad & \\text{Leibniz integral rule}\\\\\n",
    "    &= 2 p(Y)\\\\\n",
    "    &> 0.\n",
    "\n",
    "Higher Dimensions\n",
    "-----------------\n",
    "\n",
    ".. math::\n",
    "\n",
    "   Q\\left( t X + (1 - t) Y \\right)\n",
    "    &= \\int \\left\\Vert t X + (1 - t) Y - \\theta \\right\\Vert_1 p(\\theta) d\\theta\n",
    "       & \\quad & t \\in [0, 1], \\theta \\in \\mathbb{R}^n\\\\\n",
    "    &= \\int \\left(\n",
    "              \\sum_i \\left\\vert t X_i + (1 - t) Y_i - \\theta_i \\right\\vert\n",
    "            \\right)\n",
    "            p(\\theta) d\\theta\\\\\n",
    "    &= \\int \\left(\n",
    "              \\sum_i \\left\\vert\n",
    "                       t X_i + (1 - t) Y_i - t \\theta_i - (1 - t) \\theta_i\n",
    "                     \\right\\vert\n",
    "            \\right)\n",
    "            p(\\theta) d\\theta\\\\\n",
    "    &\\leq \\int \\left(\n",
    "                 \\sum_i t \\left\\vert X_i - \\theta_i \\right\\vert +\n",
    "                        (1 - t) \\left\\vert Y_i - \\theta_i \\right\\vert\n",
    "               \\right)\n",
    "               p(\\theta) d\\theta\n",
    "          & \\quad & \\text{triangle inequality}\\\\\n",
    "    &= t Q(X) + (1 - t) Q(Y).\n",
    "\n",
    "There are many definitions for a multivariate median.  The vector of marginal\n",
    "medians is a direct generalization of the median of a 1D distribution because\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\min_Y Q\n",
    "    &= \\min_Y \\int \\left\\Vert Y - \\theta \\right\\Vert_1 p(\\theta) d\\theta\\\\\n",
    "    &= \\min_Y\n",
    "         \\sum_i \\int \\left\\vert Y_i - \\theta_i \\right\\vert p(\\theta) d\\theta\\\\\n",
    "    &= \\sum_i \\min_{Y_i}\n",
    "         \\int \\left\\vert Y_i - \\theta_i \\right\\vert p(\\theta) d\\theta."
   ]
  },
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    "(iv)\n",
    "====\n",
    "\n",
    "The median of a PDF defined on :math:`\\mathbb{R}` is invariant to\n",
    "reparametrization of :math:`\\mathbb{R}`.  By inspection of the\n",
    ":ref:`minimization <hartley2004-ex-a3.iii>`, the additional scaling factor\n",
    ":math:`\\left\\vert v'(\\theta) \\right\\vert` gets canceled out.  However, this is\n",
    "not true in higher dimensions.  A specific example is the normal distribution.\n",
    "Its median and mode are equal to its mean, but a\n",
    ":ref:`change of variable <prince2012computer-ex-5.1>` gives a different\n",
    "quantity.\n",
    "\n",
    ":cite:`hannah1996geometric` has an excellent geometric interpretation of the\n",
    "determinant of a matrix.  A matrix :math:`A \\in \\mathbb{R}^{n \\times n}` can be\n",
    "viewed as a linear transformation from\n",
    ":math:`\\mathbb{R}^n \\mapsto \\mathbb{R}^n` such that a unit :math:`n`-cube in\n",
    ":math:`\\mathbb{R}^n` is mapped into the :math:`n`-dimensional parallelogram\n",
    "determined by the columns of :math:`A`.  The magnification factor\n",
    "\n",
    ".. math::\n",
    "\n",
    "   \\frac{\n",
    "     \\text{area (or volume) of image region}\n",
    "   }{\n",
    "     \\text{area (or volume) of original region}\n",
    "   } =\n",
    "   \\det A\n",
    "\n",
    "is always the same regardless of the starting hypercube.\n",
    "\n",
    "In computing an integral over a volume in any coordinate system, you break the\n",
    "volume up into little pieces and sum the value of the integrand at a point in\n",
    "each piece, times the volume of the piece.  In changing variables from any given\n",
    "set of variables of integration to any other, the Jacobian tells us how to\n",
    "express the volume element (e.g. parallelopiped) in for the old variables in\n",
    "terms of the volume element for the new set.  The key idea is that locally any\n",
    "differentiable map is linear (and takes rectangles to parallelograms), and then\n",
    "we piece the contributions over the entire region together.  The absolute value\n",
    "of the Jacobian determinant gives us the exchange rate between the two different\n",
    "volume element :cite:`miller2014covt,schwartz1954formula`."
   ]
  },
  {
   "cell_type": "raw",
   "metadata": {
    "raw_mimetype": "text/restructuredtext"
   },
   "source": [
    ".. rubric:: References\n",
    "\n",
    ".. bibliography:: appendix-03.bib"
   ]
  }
 ],
 "metadata": {
  "anaconda-cloud": {},
  "celltoolbar": "Raw Cell Format",
  "kernelspec": {
   "display_name": "Python [default]",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.5.2"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 1
}
